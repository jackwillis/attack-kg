%%{init: {'theme': 'base'}}%%

sequenceDiagram
    autonumber
    participant User
    participant CLI as CLI (main.py)
    participant Hybrid as HybridQueryEngine
    participant Vectors as ChromaDB
    participant BM25 as KeywordSearchEngine
    participant Graph as Oxigraph
    participant LLM as LLM Backend

    Note over User,LLM: Query Flow: "Found password spraying attack"

    User->>CLI: analyze "Found password spraying attack"
    CLI->>Hybrid: query(narrative, top_k=10)

    rect rgb(230, 245, 255)
        Note over Hybrid,BM25: Step 1: Hybrid Retrieval (RRF Fusion)<br/>Includes ATT&CK + LOLBAS + GTFOBins
        Hybrid->>Vectors: embed(narrative)
        Vectors-->>Hybrid: semantic candidates + similarity scores
        Hybrid->>BM25: tokenize + search(narrative)
        BM25-->>Hybrid: keyword candidates + BM25 scores
        Note over Hybrid: Reciprocal Rank Fusion<br/>score = Î£ 1/(k + rank)
        Hybrid-->>Hybrid: fused candidates [T1110.003, T1078, ...]
    end

    rect rgb(255, 245, 230)
        Note over Hybrid,Graph: Step 2: Symbolic Enrichment (SPARQL)
        loop For each candidate technique
            Hybrid->>Graph: get_technique(id)
            Graph-->>Hybrid: technique details + tactics
            Hybrid->>Graph: get_software_using(id)
            Graph-->>Hybrid: [Cobalt Strike, Mimikatz, ...]
            Hybrid->>Graph: get_campaigns_using(id)
            Graph-->>Hybrid: [Operation Ghost, ...]
            Hybrid->>Graph: get_mitigations(id)
            Graph-->>Hybrid: [M1032, M1027, ...]
            Hybrid->>Graph: get_detection_strategies(id)
            Graph-->>Hybrid: detection approaches
        end
    end

    Hybrid-->>CLI: EnrichedTechnique[]

    rect rgb(255, 230, 230)
        Note over CLI,LLM: Step 3: Single-Stage LLM Analysis (default)
        CLI->>CLI: Build TOON context (techniques, software,<br/>campaigns, mitigations, D3FEND, detections)
        CLI->>LLM: analyze(narrative, TOON_context)
        Note right of LLM: Classify techniques + write remediation<br/>Constrained to provided candidates<br/>Output: techniques, mitigations, D3FEND
        LLM-->>CLI: AnalysisResult JSON
        CLI->>CLI: Validate IDs against retrieval set
    end

    CLI-->>User: AnalysisResult<br/>{techniques, remediations, d3fend}
