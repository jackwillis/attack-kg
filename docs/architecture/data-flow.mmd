%%{init: {'theme': 'base'}}%%

sequenceDiagram
    autonumber
    participant User
    participant CLI as CLI (main.py)
    participant Hybrid as HybridQueryEngine
    participant Vectors as ChromaDB
    participant BM25 as KeywordSearchEngine
    participant Graph as Oxigraph
    participant LLM as LLM Backend

    Note over User,LLM: Query Flow: "Found password spraying attack"

    User->>CLI: analyze "Found password spraying attack"
    CLI->>Hybrid: query(narrative, top_k=10)

    rect rgb(230, 245, 255)
        Note over Hybrid,BM25: Step 1: Hybrid Retrieval (RRF Fusion)<br/>Includes ATT&CK + LOLBAS + GTFOBins
        Hybrid->>Vectors: embed(narrative)
        Vectors-->>Hybrid: semantic candidates + similarity scores
        Hybrid->>BM25: tokenize + search(narrative)
        BM25-->>Hybrid: keyword candidates + BM25 scores
        Note over Hybrid: Reciprocal Rank Fusion<br/>score = Î£ 1/(k + rank)
        Hybrid-->>Hybrid: fused candidates [T1110.003, T1078, ...]
    end

    rect rgb(255, 245, 230)
        Note over Hybrid,Graph: Step 2: Symbolic Enrichment (SPARQL)
        loop For each candidate technique
            Hybrid->>Graph: get_technique(id)
            Graph-->>Hybrid: technique details
            Hybrid->>Graph: get_tactics(id)
            Graph-->>Hybrid: [credential-access, ...]
            Hybrid->>Graph: get_groups_using(id)
            Graph-->>Hybrid: [APT29, APT28, ...]
            Hybrid->>Graph: get_mitigations(id)
            Graph-->>Hybrid: [M1036, M1027, ...]
        end
    end

    Hybrid-->>CLI: EnrichedTechnique[]

    rect rgb(255, 230, 230)
        Note over CLI,LLM: Step 3: Two-Stage LLM Reasoning
        CLI->>LLM: Stage 1: NodeSelector(narrative, candidates)
        Note right of LLM: Select techniques that apply<br/>Output: IDs only (no hallucination)<br/>Validate IDs against candidates
        LLM-->>CLI: selected_ids[] + confidence + evidence
        CLI->>CLI: Rehydrate names/tactics from graph
        CLI->>Graph: Enrich with mitigations, D3FEND
        Graph-->>CLI: mitigations[], d3fend_techniques[]
        CLI->>LLM: Stage 2: RemediationWriter(techniques, mitigations)
        Note right of LLM: Generate implementation guidance<br/>Output: mitigation IDs + priority<br/>Constrained to provided options
        LLM-->>CLI: prioritized_mitigation_ids[]
        CLI->>CLI: Rehydrate mitigation names from graph
    end

    CLI-->>User: AnalysisResult<br/>{techniques, remediations, d3fend}
