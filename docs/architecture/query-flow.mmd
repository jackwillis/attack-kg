%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4A90A4'}}}%%

sequenceDiagram
    autonumber
    participant User
    participant CLI
    participant HybridEngine as HybridQueryEngine
    participant Semantic as SemanticSearchEngine
    participant ChromaDB
    participant Keyword as KeywordSearchEngine
    participant Graph as AttackGraph
    participant Oxigraph
    participant LLM as AttackAnalyzer + LLM

    User->>CLI: analyze "password spraying attack"
    CLI->>HybridEngine: query(finding_text, top_k=5)

    rect rgb(232, 244, 248)
        Note over HybridEngine,Keyword: Hybrid Retrieval - RRF Fusion<br/>(ATT&CK + LOLBAS + GTFOBins)
        HybridEngine->>Semantic: search(finding_text)
        Semantic->>ChromaDB: query(embedding, n_results=10)
        ChromaDB-->>Semantic: semantic candidates + similarity scores<br/>+ tool→technique mappings (certutil→T1105)
        Semantic-->>HybridEngine: SemanticResult[]
        HybridEngine->>Keyword: search(finding_text)
        Keyword-->>HybridEngine: KeywordResult[] (BM25 scores)
        Note over HybridEngine: Reciprocal Rank Fusion<br/>score(d) = Σ 1/(60 + rank)
        HybridEngine->>HybridEngine: Fuse results, take top_k
    end

    rect rgb(212, 237, 218)
        Note over HybridEngine,Oxigraph: Symbolic Component - SPARQL Enrichment
        loop For each candidate technique
            HybridEngine->>Graph: get_technique_full(attack_id)
            Graph->>Oxigraph: SPARQL query
            Oxigraph-->>Graph: technique details
            HybridEngine->>Graph: get_groups_using_technique()
            HybridEngine->>Graph: get_mitigations_with_inheritance()
            HybridEngine->>Graph: get_campaigns_using_technique()
            HybridEngine->>Graph: get_detection_strategies_for_technique()
            HybridEngine->>Graph: get_data_sources_for_technique()
        end
        Graph-->>HybridEngine: enriched graph data
    end

    HybridEngine-->>CLI: EnrichedTechnique[]

    rect rgb(255, 243, 205)
        Note over CLI,LLM: Stage 1: Node Selection (LLM)
        CLI->>LLM: NodeSelector.select(finding, candidates)
        Note right of LLM: Task: Which candidates apply?<br/>Output: IDs only (no hallucination)<br/>+ confidence scores<br/>+ evidence from finding text
        LLM-->>CLI: selected_ids[] + evidence[]
        CLI->>CLI: Validate IDs against candidates
        CLI->>CLI: Rehydrate names from graph
    end

    rect rgb(212, 237, 218)
        Note over CLI,Oxigraph: Graph Enrichment
        CLI->>Graph: get_mitigations_with_inheritance(technique_ids)
        Graph->>Oxigraph: SPARQL (includes parent technique mitigations)
        Oxigraph-->>Graph: mitigations[]
        CLI->>Graph: get_d3fend_for_techniques(technique_ids)
        Graph->>Oxigraph: SPARQL (D3FEND via mitigation links)
        Oxigraph-->>Graph: d3fend_techniques[]
    end

    rect rgb(248, 215, 218)
        Note over CLI,LLM: Stage 2: Remediation Writing (LLM)
        CLI->>LLM: RemediationWriter.write(finding, techniques, mitigations, d3fend)
        Note right of LLM: Task: How to fix these issues?<br/>Constrained to provided mitigations<br/>Context-aware implementation<br/>No invented product names
        LLM-->>CLI: prioritized_mitigations[] + implementation_steps[]
        CLI->>CLI: Validate mitigation IDs
        CLI->>CLI: Rehydrate names from graph
    end

    CLI-->>User: Techniques (validated),<br/>Mitigations (prioritized),<br/>D3FEND Countermeasures,<br/>Kill Chain Analysis
